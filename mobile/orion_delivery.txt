--- FILE START: lib/core/services/storage_service.dart --- CONTENT START:
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';

// Este serviço atua como a camada de infraestrutura de persistência de chave/valor
// para todos os outros services (Auth, Journal, Strategy, etc.).
class StorageService {
  final SharedPreferences sharedPreferences;

  StorageService({required this.sharedPreferences});

  /// Salva uma lista de objetos serializáveis sob uma chave.
  Future<bool> saveList<T>(String key, List<T> items, Map<String, dynamic> Function(T) toJson) async {
    try {
      final jsonList = items.map((item) => toJson(item)).toList();
      final stringList = jsonList.map((json) => jsonEncode(json)).toList();
      return await sharedPreferences.setStringList(key, stringList);
    } catch (e) {
      // Logar erro
      return false;
    }
  }

  /// Carrega uma lista de objetos e desserializa.
  List<T> loadList<T>(String key, T Function(Map<String, dynamic>) fromJson) {
    try {
      final stringList = sharedPreferences.getStringList(key) ?? [];
      return stringList.map((jsonString) {
        final jsonMap = jsonDecode(jsonString) as Map<String, dynamic>;
        return fromJson(jsonMap);
      }).toList();
    } catch (e) {
      // Logar erro e retornar lista vazia
      return [];
    }
  }

  /// Salva um único objeto serializável.
  Future<bool> saveObject<T>(String key, T item, Map<String, dynamic> Function(T) toJson) async {
    try {
      final jsonMap = toJson(item);
      final jsonString = jsonEncode(jsonMap);
      return await sharedPreferences.setString(key, jsonString);
    } catch (e) {
      // Logar erro
      return false;
    }
  }

  /// Carrega um único objeto e desserializa.
  T? loadObject<T>(String key, T Function(Map<String, dynamic>) fromJson) {
    try {
      final jsonString = sharedPreferences.getString(key);
      if (jsonString == null) return null;
      
      final jsonMap = jsonDecode(jsonString) as Map<String, dynamic>;
      return fromJson(jsonMap);
    } catch (e) {
      // Logar erro
      return null;
    }
  }

  /// Limpa um item específico.
  Future<bool> remove(String key) async {
    return await sharedPreferences.remove(key);
  }

  /// Limpa todas as chaves do aplicativo (útil para Logout).
  Future<bool> clearAll() async {
    return await sharedPreferences.clear();
  }
}
--- CONTENT END: ---

--- FILE START: lib/core/services/bet_journal_service.dart --- CONTENT START:

Dart

import 'package:antibet/core/models/bet_journal_entry_model.dart';
import 'package:antibet/core/services/storage_service.dart';

class BetJournalService {
  final StorageService _storageService;
  static const String _journalKey = 'bet_journal_entries';

  BetJournalService(this._storageService);

  /// Carrega todas as entradas do diário de apostas do armazenamento.
  /// Retorna uma lista vazia se não houver dados.
  List<BetJournalEntryModel> loadEntries() {
    return _storageService.loadList<BetJournalEntryModel>(
      _journalKey,
      BetJournalEntryModel.fromJson,
    );
  }

  /// Salva uma nova entrada no diário e a persiste no armazenamento.
  Future<bool> saveEntry(BetJournalEntryModel newEntry) async {
    // 1. Carrega a lista atual
    final currentEntries = loadEntries();
    
    // 2. Adiciona a nova entrada no início (para mostrar as mais recentes primeiro)
    final updatedEntries = [newEntry, ...currentEntries];
    
    // 3. Salva a lista atualizada
    return await _storageService.saveList<BetJournalEntryModel>(
      _journalKey,
      updatedEntries,
      (entry) => entry.toJson(),
    );
  }

  /// Remove uma entrada existente.
  Future<bool> removeEntry(String entryId) async {
    final currentEntries = loadEntries();
    final updatedEntries = currentEntries.where((entry) => entry.id != entryId).toList();
    
    return await _storageService.saveList<BetJournalEntryModel>(
      _journalKey,
      updatedEntries,
      (entry) => entry.toJson(),
    );
  }

  /// Limpa todas as entradas do diário.
  Future<bool> clearAllEntries() async {
    return await _storageService.remove(_journalKey);
  }
}
--- CONTENT END: ---

--- FILE START: lib/core/services/bet_strategy_service.dart --- CONTENT START:

Dart

import 'package:antibet/core/models/bet_strategy_model.dart';
import 'package:antibet/core/services/storage_service.dart';

class BetStrategyService {
  final StorageService _storageService;
  static const String _strategiesKey = 'bet_strategies';

  BetStrategyService(this._storageService);

  /// Carrega todas as estratégias de aposta do armazenamento.
  /// Retorna uma lista vazia se não houver dados.
  List<BetStrategyModel> loadStrategies() {
    return _storageService.loadList<BetStrategyModel>(
      _strategiesKey,
      BetStrategyModel.fromJson,
    );
  }

  /// Salva uma nova estratégia e a persiste no armazenamento.
  Future<bool> saveStrategy(BetStrategyModel newStrategy) async {
    // 1. Carrega a lista atual
    final currentStrategies = loadStrategies();
    
    // 2. Verifica se já existe (para evitar duplicidade se o ID for o mesmo)
    final existingIndex = currentStrategies.indexWhere((s) => s.id == newStrategy.id);
    
    final updatedStrategies = List<BetStrategyModel>.from(currentStrategies);

    if (existingIndex != -1) {
      // Atualiza a estratégia existente
      updatedStrategies[existingIndex] = newStrategy;
    } else {
      // Adiciona a nova estratégia
      updatedStrategies.add(newStrategy);
    }
    
    // 3. Salva a lista atualizada
    return await _storageService.saveList<BetStrategyModel>(
      _strategiesKey,
      updatedStrategies,
      (strategy) => strategy.toJson(),
    );
  }

  /// Remove uma estratégia existente.
  Future<bool> removeStrategy(String strategyId) async {
    final currentStrategies = loadStrategies();
    final updatedStrategies = currentStrategies.where((s) => s.id != strategyId).toList();
    
    return await _storageService.saveList<BetStrategyModel>(
      _strategiesKey,
      updatedStrategies,
      (strategy) => strategy.toJson(),
    );
  }
}
--- CONTENT END: ---

--- FILE START: lib/core/services/user_profile_service.dart --- CONTENT START:

Dart

import 'package:antibet/core/models/user_profile_model.dart';
import 'package:antibet/core/services/storage_service.dart';

class UserProfileService {
  final StorageService _storageService;
  static const String _profileKey = 'user_profile_data';

  UserProfileService(this._storageService);

  /// Carrega o perfil do usuário do armazenamento.
  /// Retorna o perfil inicial se não houver dados.
  UserProfileModel loadProfile() {
    final profile = _storageService.loadObject<UserProfileModel>(
      _profileKey,
      UserProfileModel.fromJson,
    );
    return profile ?? UserProfileModel.initial();
  }

  /// Salva as alterações no perfil do usuário.
  Future<bool> saveProfile(UserProfileModel profile) async {
    return await _storageService.saveObject<UserProfileModel>(
      _profileKey,
      profile,
      (p) => p.toJson(),
    );
  }
  
  /// Limpa os dados do perfil (usado no logout).
  Future<bool> clearProfile() async {
    return await _storageService.remove(_profileKey);
  }
}
--- CONTENT END: ---
